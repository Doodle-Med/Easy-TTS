<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>VoiceCanvas - Google Cloud TTS Playground</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
:root {
  /* Light theme */
  --c1:#4285f4;
  --c2:#34a853;
  --c3:#ea4335;
  --c4:#fbbc04;
  --bg:#f8f9fa;
  --card-bg:#ffffff;
  --fg:#202124;
  --bd:#dadce0;
  --r:12px;
  --shadow: 0 4px 16px rgba(0,0,0,0.08);
  --hover-shadow: 0 8px 24px rgba(0,0,0,0.12);
  --transition: all 0.3s ease;
}

[data-theme="dark"] {
  --c1:#66a3ff;
  --c2:#58cb79;
  --c3:#ff7d6b;
  --c4:#ffd56b;
  --bg:#202124;
  --card-bg:#292a2d;
  --fg:#e8eaed;
  --bd:#5f6368;
  --shadow: 0 4px 16px rgba(0,0,0,0.25);
  --hover-shadow: 0 8px 24px rgba(0,0,0,0.3);
}

* {
  box-sizing:border-box;
  margin:0;
  padding:0;
  font-family:"Google Sans", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  transition: var(--transition);
}

body {
  background:var(--bg);
  color:var(--fg);
  padding:1rem;
  max-width:1200px;
  margin:auto;
  line-height:1.5;
}

h1 {
  font-size:clamp(1.7rem,3vw,3rem);
  text-align:center;
  margin-bottom:1.2rem;
  background:linear-gradient(90deg,var(--c1),var(--c2),var(--c4),var(--c3));
  -webkit-background-clip:text;
  background-clip:text;
  color:transparent;
  font-weight:800;
}

.subtitle {
  text-align: center;
  margin-bottom: 1.5rem;
  opacity: 0.8;
  font-size: 1.1rem;
}

.grid {
  display:grid;
  gap:1.2rem;
}

.two {
  grid-template-columns:1fr 1fr;
}

.three {
  grid-template-columns:repeat(3, 1fr);
}

@media(max-width:900px) {
  .two, .three {
    grid-template-columns:1fr;
  }
}

.card {
  background:var(--card-bg);
  border:1px solid var(--bd);
  border-radius:var(--r);
  box-shadow:var(--shadow);
  padding:1.5rem;
  position:relative;
  transition:var(--transition);
}

.card:hover {
  box-shadow:var(--hover-shadow);
}

.card-header {
  display: flex;
  align-items: center;
  margin-bottom: 1.2rem;
  gap: 0.5rem;
}

.card-header h2 {
  font-size: 1.3rem;
  margin: 0;
  flex-grow: 1;
}

.card-header .actions {
  display: flex;
  gap: 0.5rem;
}

label {
  font-weight:600;
  margin:.7rem 0 .3rem;
  display:block;
}

input, select, textarea, button, .btn {
  width:100%;
  padding:.65rem .75rem;
  border:1px solid var(--bd);
  border-radius:8px;
  font-size:1rem;
  margin-bottom:.8rem;
  background: var(--card-bg);
  color: var(--fg);
}

input:focus, select:focus, textarea:focus {
  border-color:var(--c1);
  outline:none;
  box-shadow:0 0 0 3px rgba(66,133,244,0.2);
}

textarea {
  resize:vertical;
  min-height:140px;
}

button, .btn {
  cursor:pointer;
  background:var(--c1);
  color:#fff;
  border:none;
  font-weight:500;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  transition: var(--transition);
}

button:not(:disabled):hover, .btn:not(:disabled):hover {
  background:#3367d6;
  transform: translateY(-2px);
}

button:disabled, .btn:disabled {
  background:var(--bd);
  cursor: not-allowed;
  opacity: 0.7;
}

button.secondary, .btn.secondary {
  background: transparent;
  border: 1px solid var(--bd);
  color: var(--fg);
}

button.secondary:not(:disabled):hover, .btn.secondary:not(:disabled):hover {
  background: rgba(66,133,244,0.1);
  border-color: var(--c1);
}

.small-btn {
  width:auto;
  padding: .5rem .8rem;
}

.icon-btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  background: transparent;
  color: var(--fg);
  border: 1px solid var(--bd);
  font-size: 1.1rem;
}

.icon-btn:hover {
  background: rgba(66,133,244,0.1);
  border-color: var(--c1);
  color: var(--c1);
}

.toggle {
  display: flex;
  gap: .5rem;
  margin: .8rem 0;
}

.toggle button {
  flex: 1;
  background: var(--card-bg);
  border: 1px solid var(--bd);
  color: var(--fg);
}

.toggle .active {
  background: var(--c2);
  color: #fff;
  border-color: var(--c2);
}

.status {
  min-height: 1.4em;
  font-size: .95rem;
  margin: .5rem 0;
  padding: .5rem;
  border-radius: 8px;
  transition: var(--transition);
}

.error {
  color: var(--c3);
  background: rgba(234, 67, 53, 0.1);
  font-weight: 500;
}

.success {
  color: var(--c2);
  background: rgba(52, 168, 83, 0.1);
  font-weight: 500;
}

.bar {
  height: 14px;
  background: var(--bd);
  border-radius: 7px;
  overflow: hidden;
  cursor: pointer;
  margin: .8rem 0;
  position: relative;
}

.fill {
  height: 100%;
  background: linear-gradient(90deg, var(--c1), var(--c2));
  width: 0;
  border-radius: 7px;
  transition: width 0.2s linear;
}

.bar .markers {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
}

.bar .marker {
  position: absolute;
  height: 100%;
  width: 1px;
  background: rgba(255, 255, 255, 0.5);
}

.audio-controls {
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
}

.playback-controls {
  display: flex;
  align-items: center;
  gap: .5rem;
}

.playback-controls button {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  aspect-ratio: 1/1;
  font-size: 1.1rem;
  display: grid;
  place-items: center;
  padding: 0;
}

.volume-control {
  display: flex;
  align-items: center;
  gap: .5rem;
  flex: 1;
}

.volume-control input {
  margin: 0;
}

.time {
  font-family: monospace;
  font-size: 1rem;
  white-space: nowrap;
}

.text-box {
  background:var(--card-bg);
  border:1px solid var(--bd);
  border-radius:var(--r);
  padding:1rem;
  max-height:340px;
  overflow:auto;
  line-height:1.6;
}

.word {
  display:inline-block;
  cursor:pointer;
  border-radius:3px;
  padding:1px 2px;
  transition: all 0.2s ease;
}

.word:hover {
  background:rgba(66,133,244,0.1);
}

.word.active {
  background:rgba(66,133,244,0.25);
  color:var(--c1);
  font-weight:700;
}

.word.loading {
  background: linear-gradient(90deg, rgba(0,0,0,0.05), rgba(0,0,0,0.1), rgba(0,0,0,0.05));
  background-size: 200% 100%;
  animation: shine 1.5s infinite;
  cursor:wait;
  opacity:0.7;
}

.waveform {
  width: 100%;
  height: 80px;
  background: var(--card-bg);
  border: 1px solid var(--bd);
  border-radius: 8px;
  margin: .8rem 0;
  overflow: hidden;
}

.section {
  margin-bottom: 1.2rem;
}

.tabs {
  display: flex;
  gap: .5rem;
  margin-bottom: 1rem;
  overflow-x: auto;
  padding-bottom: .5rem;
}

.tab {
  padding: .5rem 1rem;
  border: 1px solid var(--bd);
  border-radius: 20px;
  cursor: pointer;
  white-space: nowrap;
}

.tab.active {
  background: var(--c1);
  color: #fff;
  border-color: var(--c1);
}

.row {
  display: flex;
  gap: 1rem;
  align-items: center;
  flex-wrap: wrap;
}

.col {
  flex: 1;
  min-width: 200px;
}

.search-box {
  position: relative;
  margin-bottom: 1rem;
}

.search-box input {
  padding-left: 2.5rem;
}

.search-box i {
  position: absolute;
  left: 1rem;
  top: 50%;
  transform: translateY(-50%);
  color: var(--bd);
}

.filters {
  margin-bottom: 1rem;
  display: flex;
  flex-wrap: wrap;
  gap: .5rem;
}

.filter {
  padding: .3rem .8rem;
  border-radius: 20px;
  background: rgba(66,133,244,0.1);
  color: var(--c1);
  font-size: 0.85rem;
  cursor: pointer;
}

.filter.active {
  background: var(--c1);
  color: #fff;
}

.select-wrapper {
  position: relative;
}

.select-wrapper:after {
  content: '\f078';
  font-family: 'Font Awesome 6 Free';
  font-weight: 900;
  position: absolute;
  right: 1rem;
  top: 50%;
  transform: translateY(-50%);
  color: var(--bd);
  pointer-events: none;
}

.badge {
  display: inline-block;
  padding: .2rem .5rem;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 500;
  margin-left: .5rem;
}

.badge.blue {
  background: rgba(66,133,244,0.1);
  color: var(--c1);
}

.badge.green {
  background: rgba(52,168,83,0.1);
  color: var(--c2);
}

.badge.red {
  background: rgba(234,67,53,0.1);
  color: var(--c3);
}

.badge.yellow {
  background: rgba(251,188,4,0.1);
  color: var(--c4);
}

.voice-list {
  max-height: 250px;
  overflow-y: auto;
  border: 1px solid var(--bd);
  border-radius: 8px;
  margin-bottom: 1rem;
}

.voice-item {
  display: flex;
  align-items: center;
  padding: .7rem;
  border-bottom: 1px solid var(--bd);
  cursor: pointer;
}

.voice-item:last-child {
  border-bottom: none;
}

.voice-item:hover {
  background: rgba(66,133,244,0.05);
}

.voice-item.selected {
  background: rgba(66,133,244,0.1);
}

.voice-icon {
  font-size: 1.1rem;
  color: var(--c1);
  margin-right: .7rem;
}

.voice-name {
  flex: 1;
}

.voice-gender {
  opacity: 0.7;
  font-size: 0.85rem;
}

.slider-value {
  width: 40px;
  text-align: right;
}

.floating-buttons {
  position: fixed;
  bottom: 2rem;
  right: 2rem;
  display: flex;
  flex-direction: column;
  gap: .7rem;
  z-index: 100;
}

.floating-buttons .icon-btn {
  width: 50px;
  height: 50px;
  font-size: 1.2rem;
  box-shadow: var(--shadow);
}

.tooltip {
  position: relative;
}

.tooltip:hover:after {
  content: attr(data-tooltip);
  position: absolute;
  right: 100%;
  top: 50%;
  transform: translateY(-50%);
  margin-right: 10px;
  background: var(--fg);
  color: var(--bg);
  padding: .3rem .7rem;
  border-radius: 4px;
  font-size: 0.85rem;
  white-space: nowrap;
  z-index: 101;
}

.tooltip:hover:before {
  content: '';
  position: absolute;
  right: 100%;
  top: 50%;
  transform: translateY(-50%);
  margin-right: 5px;
  border-left: 5px solid var(--fg);
  border-top: 5px solid transparent;
  border-bottom: 5px solid transparent;
  z-index: 101;
}

.effects-panel {
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid var(--bd);
}

.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

.modal.show {
  opacity: 1;
  pointer-events: auto;
}

.modal-content {
  background: var(--card-bg);
  border-radius: var(--r);
  padding: 1.5rem;
  width: 90%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: var(--shadow);
  transform: translateY(-20px);
  transition: transform 0.3s ease;
}

.modal.show .modal-content {
  transform: translateY(0);
}

.modal-header {
  display: flex;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--bd);
}

.modal-header h3 {
  flex: 1;
  margin: 0;
}

.modal-close {
  background: transparent;
  border: none;
  color: var(--fg);
  font-size: 1.5rem;
  width: auto;
  margin: 0;
  padding: 0;
  cursor: pointer;
}

.modal-close:hover {
  color: var(--c3);
  transform: none;
}

.keyboard-shortcuts {
  margin-top: 1rem;
}

.shortcut {
  display: flex;
  align-items: center;
  margin-bottom: .7rem;
}

.shortcut-key {
  display: inline-block;
  padding: .3rem .7rem;
  background: var(--bg);
  border: 1px solid var(--bd);
  border-radius: 4px;
  font-family: monospace;
  margin-right: 1rem;
  width: 50px;
  text-align: center;
}

.shortcut-desc {
  flex: 1;
}

.saved-configs {
  max-height: 300px;
  overflow-y: auto;
  margin-bottom: 1rem;
}

.config-item {
  display: flex;
  align-items: center;
  padding: .7rem;
  border: 1px solid var(--bd);
  border-radius: 8px;
  margin-bottom: .5rem;
}

.config-name {
  flex: 1;
  font-weight: 500;
}

.config-actions {
  display: flex;
  gap: .5rem;
}

.dropdown {
  position: relative;
  display: inline-block;
}

.dropdown-menu {
  position: absolute;
  top: 100%;
  right: 0;
  background: var(--card-bg);
  border: 1px solid var(--bd);
  border-radius: 8px;
  min-width: 150px;
  box-shadow: var(--shadow);
  z-index: 10;
  display: none;
}

.dropdown-menu.show {
  display: block;
}

.dropdown-item {
  padding: .7rem 1rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: .5rem;
}

.dropdown-item:hover {
  background: rgba(66,133,244,0.1);
}

.dropdown-divider {
  height: 1px;
  background: var(--bd);
  margin: .3rem 0;
}

.history-list {
  max-height: 300px;
  overflow-y: auto;
}

.history-item {
  padding: .7rem;
  border: 1px solid var(--bd);
  border-radius: 8px;
  margin-bottom: .5rem;
  cursor: pointer;
}

.history-item:hover {
  background: rgba(66,133,244,0.05);
}

.history-text {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: .3rem;
}

.history-meta {
  display: flex;
  justify-content: space-between;
  font-size: 0.85rem;
  opacity: 0.7;
}

.spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid rgba(66,133,244,0.3);
  border-radius: 50%;
  border-top-color: var(--c1);
  animation: spin 0.8s linear infinite;
  margin-right: 5px;
}

.skeleton {
  background: linear-gradient(90deg, rgba(0,0,0,0.05), rgba(0,0,0,0.1), rgba(0,0,0,0.05));
  background-size: 200% 100%;
  animation: shine 1.5s infinite;
  height: 20px;
  border-radius: 4px;
  margin-bottom: .5rem;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

@keyframes shine {
  to { background-position: -200% 0; }
}

.hidden {
  display: none !important;
}

/* Custom scrollbars */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: var(--bg);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: var(--bd);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--c1);
}
</style>
</head>
<body>
<h1>VoiceCanvas</h1>
<p class="subtitle">Advanced Google Cloud TTS Playground</p>

<div class="grid two">
  <div class="card">
    <div class="card-header">
      <h2><i class="fas fa-cog"></i> Configuration</h2>
      <div class="actions">
        <button id="saveConfig" class="icon-btn tooltip" data-tooltip="Save Config"><i class="fas fa-save"></i></button>
        <button id="loadConfig" class="icon-btn tooltip" data-tooltip="Load Config"><i class="fas fa-folder-open"></i></button>
      </div>
    </div>
    
    <div class="section">
      <label for="k">API Key</label>
      <div class="row">
        <div style="flex: 1">
          <input id="k" type="password" placeholder="Enter your Google Cloud API Key"/>
        </div>
        <button class="small-btn" id="ld"><i class="fas fa-sync-alt"></i> Load Voices</button>
      </div>
      <div id="loading" class="status hidden"><span class="spinner"></span>Loading voices...</div>
    </div>
    
    <div class="section">
      <label for="txt">Text</label>
      <textarea id="txt" placeholder="Type or paste text here..."></textarea>
    </div>
    
    <div class="section">
      <label>Voice Selection</label>
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="voiceSearch" placeholder="Search for voices..."/>
      </div>
      
      <div class="filters">
        <div class="filter active" data-filter="all">All</div>
        <div class="filter" data-filter="neural">Neural</div>
        <div class="filter" data-filter="standard">Standard</div>
        <div class="filter" data-filter="male">Male</div>
        <div class="filter" data-filter="female">Female</div>
      </div>
      
      <div class="voice-list" id="voiceList">
        <div class="voice-item">
          <span class="voice-icon"><i class="fas fa-microphone-alt"></i></span>
          <span class="voice-name">Select a voice from the list</span>
        </div>
      </div>
      
      <div class="select-wrapper hidden">
        <select id="v" disabled></select>
      </div>
    </div>
    
    <div class="section">
      <div class="row">
        <div class="col">
          <label for="pit">Pitch <span id="pitVal">0</span></label>
          <div class="row">
            <input id="pit" type="range" min="-20" max="20" value="0" step="1"/>
            <span class="slider-value" id="pitValue">0</span>
          </div>
        </div>
        <div class="col">
          <label for="rat">Rate <span id="ratVal">1.00</span></label>
          <div class="row">
            <input id="rat" type="range" min="0.25" max="4" step="0.05" value="1"/>
            <span class="slider-value" id="ratValue">1.00</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="section">
      <div class="row">
        <div class="col">
          <label for="chk">Chunk Size <span id="chkVal">1000</span> chars</label>
          <div class="row">
            <input id="chk" type="range" min="500" max="5000" step="500" value="1000"/>
            <span class="slider-value" id="chkValue">1000</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="section">
      <label>Splitting Method</label>
      <div class="toggle" id="method">
        <button data-m="sentence"><i class="fas fa-ellipsis-h"></i> Sentence</button>
        <button data-m="paragraph" class="active"><i class="fas fa-paragraph"></i> Paragraph</button>
        <button data-m="exact"><i class="fas fa-ruler"></i> Exact</button>
      </div>
    </div>
    
    <div class="section effects-panel" id="effectsPanel">
      <label>Audio Effects <span class="badge blue">New</span></label>
      <div class="row">
        <div class="col">
          <label for="reverbLevel">Reverb</label>
          <div class="row">
            <input id="reverbLevel" type="range" min="0" max="1" step="0.01" value="0"/>
            <span class="slider-value" id="reverbValue">0.00</span>
          </div>
        </div>
        <div class="col">
          <label for="echoLevel">Echo</label>
          <div class="row">
            <input id="echoLevel" type="range" min="0" max="1" step="0.01" value="0"/>
            <span class="slider-value" id="echoValue">0.00</span>
          </div>
        </div>
      </div>
    </div>
    
    <button id="gen" disabled><i class="fas fa-magic"></i> Generate & Play</button>
    <div id="stat" class="status"></div>
  </div>
  
  <div class="card">
    <div class="card-header">
      <h2><i class="fas fa-headphones"></i> Playback</h2>
      <div class="actions">
        <button id="downloadAudio" class="icon-btn tooltip" data-tooltip="Download Audio" disabled><i class="fas fa-download"></i></button>
        <button id="showHistory" class="icon-btn tooltip" data-tooltip="History"><i class="fas fa-history"></i></button>
      </div>
    </div>
    
    <div id="text" class="text-box">
      <p style="opacity:.7; text-align: center;">Generated text will appear here...</p>
    </div>
    
    <div class="waveform" id="waveform"></div>
    
    <div class="bar" id="prog">
      <div class="fill" id="fill"></div>
      <div class="markers" id="markers"></div>
    </div>
    
    <div class="audio-controls">
      <div class="playback-controls">
        <button class="small-btn" id="play" disabled title="Play"><i class="fas fa-play"></i></button>
        <button class="small-btn" id="pause" disabled title="Pause"><i class="fas fa-pause"></i></button>
        <button class="small-btn" id="stop" disabled title="Stop"><i class="fas fa-stop"></i></button>
      </div>
      
      <div class="volume-control">
        <i class="fas fa-volume-up"></i>
        <input type="range" id="volume" min="0" max="1" step="0.01" value="1"/>
      </div>
      
      <span class="time" id="time">00:00 / 00:00</span>
    </div>
  </div>
</div>

<!-- Floating buttons -->
<div class="floating-buttons">
  <button class="icon-btn tooltip" id="toggleTheme" data-tooltip="Toggle Theme"><i class="fas fa-moon"></i></button>
  <button class="icon-btn tooltip" id="showKeyboardShortcuts" data-tooltip="Keyboard Shortcuts"><i class="fas fa-keyboard"></i></button>
</div>

<!-- Modals -->
<div class="modal" id="keyboardShortcutsModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-keyboard"></i> Keyboard Shortcuts</h3>
      <button class="modal-close">&times;</button>
    </div>
    <div class="keyboard-shortcuts">
      <div class="shortcut">
        <span class="shortcut-key">Space</span>
        <span class="shortcut-desc">Play/Pause audio</span>
      </div>
      <div class="shortcut">
        <span class="shortcut-key">Esc</span>
        <span class="shortcut-desc">Stop playback</span>
      </div>
      <div class="shortcut">
        <span class="shortcut-key">→</span>
        <span class="shortcut-desc">Skip forward 5 seconds</span>
      </div>
      <div class="shortcut">
        <span class="shortcut-key">←</span>
        <span class="shortcut-desc">Skip backward 5 seconds</span>
      </div>
      <div class="shortcut">
        <span class="shortcut-key">↑</span>
        <span class="shortcut-desc">Increase volume</span>
      </div>
      <div class="shortcut">
        <span class="shortcut-key">↓</span>
        <span class="shortcut-desc">Decrease volume</span>
      </div>
      <div class="shortcut">
        <span class="shortcut-key">G</span>
        <span class="shortcut-desc">Generate audio (when configured)</span>
      </div>
      <div class="shortcut">
        <span class="shortcut-key">T</span>
        <span class="shortcut-desc">Toggle dark/light theme</span>
      </div>
      <div class="shortcut">
        <span class="shortcut-key">S</span>
        <span class="shortcut-desc">Save current configuration</span>
      </div>
      <div class="shortcut">
        <span class="shortcut-key">L</span>
        <span class="shortcut-desc">Load saved configuration</span>
      </div>
      <div class="shortcut">
        <span class="shortcut-key">D</span>
        <span class="shortcut-desc">Download audio (when available)</span>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="saveConfigModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-save"></i> Save Configuration</h3>
      <button class="modal-close">&times;</button>
    </div>
    <label for="configName">Configuration Name</label>
    <input type="text" id="configName" placeholder="My Configuration">
    <button id="saveConfigBtn"><i class="fas fa-save"></i> Save</button>
  </div>
</div>

<div class="modal" id="loadConfigModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-folder-open"></i> Load Configuration</h3>
      <button class="modal-close">&times;</button>
    </div>
    <div class="saved-configs" id="savedConfigs">
      <p style="text-align: center; opacity: 0.7;">No saved configurations found.</p>
    </div>
  </div>
</div>

<div class="modal" id="historyModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-history"></i> History</h3>
      <button class="modal-close">&times;</button>
    </div>
    <div class="history-list" id="historyList">
      <p style="text-align: center; opacity: 0.7;">No history yet.</p>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/6.6.3/wavesurfer.min.js"></script>
<script>
window.addEventListener('DOMContentLoaded', () => {
  // API endpoints & DOM elements
  const VO = 'https://texttospeech.googleapis.com/v1/voices';
  const SY = 'https://texttospeech.googleapis.com/v1/text:synthesize';
  const Q = id => document.getElementById(id);
  const E = {
    key: Q('k'),
    load: Q('ld'),
    loading: Q('loading'),
    txt: Q('txt'),
    voice: Q('v'),
    voiceList: Q('voiceList'),
    voiceSearch: Q('voiceSearch'),
    pit: Q('pit'),
    rat: Q('rat'),
    pitVal: Q('pitVal'),
    ratVal: Q('ratVal'),
    pitValue: Q('pitValue'),
    ratValue: Q('ratValue'),
    chk: Q('chk'),
    chkVal: Q('chkVal'),
    chkValue: Q('chkValue'),
    gen: Q('gen'),
    stat: Q('stat'),
    methodBtns: [...Q('method').children],
    textBox: Q('text'),
    play: Q('play'),
    pause: Q('pause'),
    stop: Q('stop'),
    prog: Q('prog'),
    fill: Q('fill'),
    markers: Q('markers'),
    time: Q('time'),
    volume: Q('volume'),
    toggleTheme: Q('toggleTheme'),
    downloadAudio: Q('downloadAudio'),
    saveConfig: Q('saveConfig'),
    loadConfig: Q('loadConfig'),
    waveform: Q('waveform'),
    showKeyboardShortcuts: Q('showKeyboardShortcuts'),
    keyboardShortcutsModal: Q('keyboardShortcutsModal'),
    saveConfigModal: Q('saveConfigModal'),
    loadConfigModal: Q('loadConfigModal'),
    historyModal: Q('historyModal'),
    showHistory: Q('showHistory'),
    configName: Q('configName'),
    saveConfigBtn: Q('saveConfigBtn'),
    savedConfigs: Q('savedConfigs'),
    historyList: Q('historyList'),
    filters: document.querySelectorAll('.filter'),
    reverbLevel: Q('reverbLevel'),
    echoLevel: Q('echoLevel'),
    reverbValue: Q('reverbValue'),
    echoValue: Q('echoValue'),
    effectsPanel: Q('effectsPanel')
  };

  // ==================
  // App state
  // ==================
  let API = localStorage.getItem('apiKey') || '';
  let ctx;
  let gainNode;
  let effectNodes = {}; // Store audio effect nodes
  let voices = [];
  let filteredVoices = [];
  let selectedVoice = null;
  let buffers = [];
  let rawBuffers = []; // For downloading
  let audioSources = []; // Track all audio sources
  let wordElements = []; // Store word elements for efficient lookup
  let wordOffsets = []; // Track which chunk each word belongs to
  let totalDuration = 0; // Total final duration
  let loadedDuration = 0; // Duration of loaded chunks so far
  let startTime = 0; // When playback started
  let pausedAt = 0; // Where we paused
  let playbackId = 0; // Used to cancel stale playback
  let playing = false;
  let paused = false;
  let method = 'paragraph';
  let currentWordIndex = -1;
  let loadingComplete = false;
  let chunksReceived = 0;
  let totalChunks = 0;
  let isDarkMode = localStorage.getItem('darkMode') === 'true';
  let waveform = null;
  let savedConfigs = JSON.parse(localStorage.getItem('savedConfigs') || '[]');
  let history = JSON.parse(localStorage.getItem('history') || '[]');

  // ==================
  // Initialization
  // ==================
  
  // Initialize theme
  if (isDarkMode) {
    document.documentElement.setAttribute('data-theme', 'dark');
    E.toggleTheme.querySelector('i').classList.replace('fa-moon', 'fa-sun');
  }
  
  // Initialize API key if saved
  if (API) {
    E.key.value = API;
    setTimeout(() => E.load.click(), 500); // Auto-load voices after a short delay
  }
  
  // Initialize audio context when user interacts
  const initAudio = () => {
    if (!ctx) {
      ctx = new (window.AudioContext || window.webkitAudioContext)();
      
      // Create master gain node for volume control
      gainNode = ctx.createGain();
      gainNode.gain.value = E.volume.value;
      gainNode.connect(ctx.destination);
      
      // Create effect nodes
      createAudioEffects();
      
      document.removeEventListener('click', initAudio);
    }
  };
  document.addEventListener('click', initAudio);
  
  // Initialize waveform
  const initWaveform = () => {
    if (waveform) return;
    
    waveform = WaveSurfer.create({
      container: E.waveform,
      waveColor: '#4285f4',
      progressColor: '#34a853',
      cursorColor: '#ea4335',
      height: 80,
      responsive: true,
      normalize: true,
      barWidth: 2,
      barGap: 1,
      barRadius: 2
    });
    
    waveform.on('ready', () => {
      log('Waveform visualization ready');
    });
    
    waveform.on('click', (e) => {
      if (loadingComplete) {
        const duration = waveform.getDuration();
        const position = e.clientX / E.waveform.clientWidth;
        const time = position * duration;
        seekToTime(time);
      }
    });
  };

  // ==================
  // Utilities
  // ==================
  
  // Format seconds to MM:SS
  const fmt = s => {
    s = Math.max(0, s || 0);
    return `${String(Math.floor(s/60)).padStart(2, '0')}:${String(Math.floor(s%60)).padStart(2, '0')}`;
  };
  
  // Show status message
  const status = (m, type = 'info') => {
    E.stat.textContent = m;
    E.stat.className = 'status';
    
    if (type === 'error') {
      E.stat.classList.add('error');
    } else if (type === 'success') {
      E.stat.classList.add('success');
    }
    
    log(type === 'error' ? `Error: ${m}` : m);
  };
  
  // Console logging helper
  const log = (message, data) => {
    const time = new Date().toLocaleTimeString();
    console.log(`[${time}] ${message}`, data || '');
  };
  
  // JSON fetch helper with error handling
  const fetchJSON = async (url, opts) => {
    try {
      const r = await fetch(url, opts);
      if (!r.ok) {
        let m = `HTTP ${r.status}`;
        try {
          const errorData = await r.json();
          m = errorData.error?.message || m;
          log('API Error', errorData);
        } catch (e) {
          log('Failed to parse error response', e);
        }
        throw new Error(m);
      }
      return r.json();
    } catch (e) {
      log('Fetch error:', e);
      throw e;
    }
  };
  
  // Show modal
  const showModal = (modalEl) => {
    modalEl.classList.add('show');
  };
  
  // Hide modal
  const hideModal = (modalEl) => {
    modalEl.classList.remove('show');
  };
  
  // Update history
  const addToHistory = (text, voice, settings) => {
    const item = {
      id: Date.now(),
      date: new Date().toISOString(),
      text: text.substring(0, 100) + (text.length > 100 ? '...' : ''),
      voice: voice,
      settings: settings
    };
    
    history.unshift(item);
    
    // Keep max 20 items
    if (history.length > 20) {
      history.pop();
    }
    
    localStorage.setItem('history', JSON.stringify(history));
    updateHistoryList();
  };
  
  // Update history list
  const updateHistoryList = () => {
    if (history.length === 0) {
      E.historyList.innerHTML = '<p style="text-align: center; opacity: 0.7;">No history yet.</p>';
      return;
    }
    
    E.historyList.innerHTML = history.map(item => `
      <div class="history-item" data-id="${item.id}">
        <div class="history-text">${item.text}</div>
        <div class="history-meta">
          <span>${item.voice.name}</span>
          <span>${new Date(item.date).toLocaleString()}</span>
        </div>
      </div>
    `).join('');
    
    // Add event listeners
    document.querySelectorAll('.history-item').forEach(el => {
      el.addEventListener('click', () => {
        const id = parseInt(el.dataset.id);
        const item = history.find(h => h.id === id);
        if (item) {
          loadFromHistory(item);
          hideModal(E.historyModal);
        }
      });
    });
  };
  
  // Load from history
  const loadFromHistory = (item) => {
    E.txt.value = item.text;
    
    // Find voice in loaded voices
    if (voices.length > 0) {
      const voice = voices.find(v => v.name === item.voice.name);
      if (voice) {
        selectVoice(voice);
      }
    }
    
    // Apply settings
    E.pit.value = item.settings.pitch;
    E.rat.value = item.settings.rate;
    E.chk.value = item.settings.chunkSize;
    E.reverbLevel.value = item.settings.reverb || 0;
    E.echoLevel.value = item.settings.echo || 0;
    
    // Update displays
    E.pitVal.textContent = E.pitValue.textContent = item.settings.pitch;
    E.ratVal.textContent = E.ratValue.textContent = parseFloat(item.settings.rate).toFixed(2);
    E.chkVal.textContent = E.chkValue.textContent = item.settings.chunkSize;
    E.reverbValue.textContent = parseFloat(item.settings.reverb || 0).toFixed(2);
    E.echoValue.textContent = parseFloat(item.settings.echo || 0).toFixed(2);
    
    // Set method
    method = item.settings.method;
    E.methodBtns.forEach(btn => {
      btn.classList.toggle('active', btn.dataset.m === method);
    });
    
    status('Loaded from history', 'success');
  };
  
  // Save current config
  const saveCurrentConfig = (name) => {
    if (!name.trim()) {
      alert('Please enter a name for this configuration');
      return;
    }
    
    if (!selectedVoice) {
      alert('Please select a voice first');
      return;
    }
    
    const config = {
      id: Date.now(),
      name: name.trim(),
      voice: {
        name: selectedVoice.name,
        languageCode: selectedVoice.languageCodes[0]
      },
      settings: {
        pitch: parseInt(E.pit.value),
        rate: parseFloat(E.rat.value),
        chunkSize: parseInt(E.chk.value),
        method: method,
        reverb: parseFloat(E.reverbLevel.value),
        echo: parseFloat(E.echoLevel.value)
      }
    };
    
    // Check if config with this name already exists
    const index = savedConfigs.findIndex(c => c.name === config.name);
    if (index >= 0) {
      if (confirm(`A configuration named "${config.name}" already exists. Replace it?`)) {
        savedConfigs[index] = config;
      } else {
        return;
      }
    } else {
      savedConfigs.push(config);
    }
    
    localStorage.setItem('savedConfigs', JSON.stringify(savedConfigs));
    status(`Configuration "${config.name}" saved`, 'success');
    updateSavedConfigsList();
    
    return true;
  };
  
  // Update saved configs list
  const updateSavedConfigsList = () => {
    if (savedConfigs.length === 0) {
      E.savedConfigs.innerHTML = '<p style="text-align: center; opacity: 0.7;">No saved configurations found.</p>';
      return;
    }
    
    E.savedConfigs.innerHTML = savedConfigs.map(config => `
      <div class="config-item">
        <div class="config-name">${config.name}</div>
        <div class="config-actions">
          <button class="small-btn load-config" data-id="${config.id}">Load</button>
          <button class="small-btn secondary delete-config" data-id="${config.id}">Delete</button>
        </div>
      </div>
    `).join('');
    
    // Add event listeners
    document.querySelectorAll('.load-config').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = parseInt(btn.dataset.id);
        loadConfig(id);
      });
    });
    
    document.querySelectorAll('.delete-config').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const id = parseInt(btn.dataset.id);
        if (confirm('Are you sure you want to delete this configuration?')) {
          savedConfigs = savedConfigs.filter(c => c.id !== id);
          localStorage.setItem('savedConfigs', JSON.stringify(savedConfigs));
          updateSavedConfigsList();
        }
      });
    });
  };
  
  // Load config
  const loadConfig = (id) => {
    const config = savedConfigs.find(c => c.id === id);
    if (!config) return;
    
    // Find voice in loaded voices
    if (voices.length > 0) {
      const voice = voices.find(v => v.name === config.voice.name);
      if (voice) {
        selectVoice(voice);
      }
    }
    
    // Apply settings
    E.pit.value = config.settings.pitch;
    E.rat.value = config.settings.rate;
    E.chk.value = config.settings.chunkSize;
    E.reverbLevel.value = config.settings.reverb || 0;
    E.echoLevel.value = config.settings.echo || 0;
    
    // Update displays
    E.pitVal.textContent = E.pitValue.textContent = config.settings.pitch;
    E.ratVal.textContent = E.ratValue.textContent = parseFloat(config.settings.rate).toFixed(2);
    E.chkVal.textContent = E.chkValue.textContent = config.settings.chunkSize;
    E.reverbValue.textContent = parseFloat(config.settings.reverb || 0).toFixed(2);
    E.echoValue.textContent = parseFloat(config.settings.echo || 0).toFixed(2);
    
    // Set method
    method = config.settings.method;
    E.methodBtns.forEach(btn => {
      btn.classList.toggle('active', btn.dataset.m === method);
    });
    
    hideModal(E.loadConfigModal);
    status(`Configuration "${config.name}" loaded`, 'success');
  };
  
  // Create and connect audio effects
  const createAudioEffects = () => {
    if (!ctx) return;
    
    // Reverb
    const convolver = ctx.createConvolver();
    createReverbImpulse(2, 0.8).then(impulseBuffer => {
      convolver.buffer = impulseBuffer;
    });
    
    // Delay for echo
    const delay = ctx.createDelay(1.0);
    delay.delayTime.value = 0.3;
    
    const delayGain = ctx.createGain();
    delayGain.gain.value = 0;
    
    // Store nodes
    effectNodes.convolver = convolver;
    effectNodes.convolverGain = ctx.createGain();
    effectNodes.convolverGain.gain.value = 0; // Start with 0 reverb
    
    effectNodes.delay = delay;
    effectNodes.delayGain = delayGain;
    
    effectNodes.dryGain = ctx.createGain();
    effectNodes.dryGain.gain.value = 1;
    
    // Connection routing
    effectNodes.dryGain.connect(gainNode);
    
    // Reverb path
    effectNodes.convolverGain.connect(convolver);
    convolver.connect(gainNode);
    
    // Echo path
    delay.connect(delayGain);
    delayGain.connect(delay); // Feedback
    delayGain.connect(gainNode);
  };
  
  // Update audio effects based on slider values
  const updateAudioEffects = () => {
    if (!ctx || !effectNodes.convolverGain || !effectNodes.delayGain) return;
    
    const reverbLevel = parseFloat(E.reverbLevel.value);
    const echoLevel = parseFloat(E.echoLevel.value);
    
    // Update reverb
    effectNodes.convolverGain.gain.value = reverbLevel;
    
    // Update echo
    effectNodes.delayGain.gain.value = echoLevel * 0.5; // Reduce feedback to avoid overwhelming echo
    
    // Update displays
    E.reverbValue.textContent = reverbLevel.toFixed(2);
    E.echoValue.textContent = echoLevel.toFixed(2);
  };
  
  // Create reverb impulse response
  const createReverbImpulse = async (duration, decay) => {
    const sampleRate = ctx.sampleRate;
    const length = sampleRate * duration;
    const impulse = ctx.createBuffer(2, length, sampleRate);
    const impulseL = impulse.getChannelData(0);
    const impulseR = impulse.getChannelData(1);
    
    for (let i = 0; i < length; i++) {
      const n = i / length;
      // Decay curve
      const amplitude = Math.pow(1 - n, decay);
      // Random noise
      impulseL[i] = (Math.random() * 2 - 1) * amplitude;
      impulseR[i] = (Math.random() * 2 - 1) * amplitude;
    }
    
    return impulse;
  };
  
  // UI event binding for sliders
  ['pit', 'rat', 'chk', 'reverbLevel', 'echoLevel'].forEach(id => {
    E[id].addEventListener('input', e => {
      const value = parseFloat(e.target.value);
      
      // Update value displays
      if (id === 'pit') {
        E.pitVal.textContent = E.pitValue.textContent = value;
      } else if (id === 'rat') {
        E.ratVal.textContent = E.ratValue.textContent = value.toFixed(2);
      } else if (id === 'chk') {
        E.chkVal.textContent = E.chkValue.textContent = value;
      } else if (id === 'reverbLevel' || id === 'echoLevel') {
        updateAudioEffects();
      }
    });
  });
  
  // Volume control handler
  E.volume.addEventListener('input', () => {
    if (gainNode) {
      gainNode.gain.value = E.volume.value;
    }
  });

  // ==================
  // Voice Loading & Selection
  // ==================
  
  // Load voices from Google TTS API
  E.load.onclick = async () => {
    API = E.key.value.trim();
    if (!API) return status('API key required', 'error');
    
    // Save API key to localStorage
    localStorage.setItem('apiKey', API);
    
    E.loading.classList.remove('hidden');
    E.load.disabled = true;
    status('Loading voices...');
    
    try {
      log(`Requesting voices from ${VO}`);
      const d = await fetchJSON(`${VO}?key=${API}`);
      voices = d.voices || [];
      
      if (!voices.length) throw new Error('No voices returned');
      
      log(`Loaded ${voices.length} voices`);
      
      // Add voice data for filtering
      voices.forEach(voice => {
        voice.isNeural = voice.name.includes('Neural') || voice.name.includes('Wavenet');
        voice.isStandard = !voice.isNeural;
        voice.isMale = voice.ssmlGender === 'MALE';
        voice.isFemale = voice.ssmlGender === 'FEMALE';
      });
      
      // Default to showing all voices
      filteredVoices = [...voices];
      
      // Populate the voice list UI
      populateVoiceList(filteredVoices);
      
      // Also populate the traditional dropdown as fallback
      populateVoiceDropdown(voices);
      
      E.gen.disabled = false;
      status('Voices loaded successfully', 'success');
    } catch (e) {
      status(`Failed to load voices: ${e.message}`, 'error');
    } finally {
      E.loading.classList.add('hidden');
      E.load.disabled = false;
    }
  };
  
  // Populate voice list UI
  const populateVoiceList = (voices) => {
    if (!voices.length) {
      E.voiceList.innerHTML = '<p style="padding: 1rem; text-align: center; opacity: 0.7;">No voices found matching your filters</p>';
      return;
    }
    
    // Group voices by language
    const langMap = new Map();
    voices.forEach(voice => {
      voice.languageCodes.forEach(code => {
        let name;
        try {
          name = new Intl.DisplayNames(['en'], { type: 'language' }).of(code);
        } catch (e) {
          name = code;
        }
        
        if (!langMap.has(code)) {
          langMap.set(code, { name, voices: [] });
        }
        langMap.get(code).voices.push(voice);
      });
    });
    
    // Sort languages alphabetically
    const sortedLangs = [...langMap.entries()].sort((a, b) => 
      a[1].name.localeCompare(b[1].name)
    );
    
    // Build HTML
    let html = '';
    sortedLangs.forEach(([code, { name, voices }]) => {
      // Sort voices by name
      voices.sort((a, b) => a.name.localeCompare(b.name));
      
      voices.forEach(voice => {
        const isNeural = voice.isNeural;
        const genderIcon = voice.isMale ? 'fa-male' : (voice.isFemale ? 'fa-female' : 'fa-user');
        
        html += `
          <div class="voice-item" data-name="${voice.name}" data-code="${code}">
            <span class="voice-icon"><i class="fas ${isNeural ? 'fa-microphone-alt' : 'fa-microphone'}"></i></span>
            <div class="voice-name">
              ${voice.name}
              <div class="voice-gender">${name} (${voice.ssmlGender}) ${isNeural ? '<span class="badge blue">Neural</span>' : ''}</div>
            </div>
            <i class="fas ${genderIcon}" style="opacity:0.5; margin-left: 0.5rem;"></i>
          </div>
        `;
      });
    });
    
    E.voiceList.innerHTML = html;
    
    // Add event listeners to voice items
    document.querySelectorAll('.voice-item').forEach(item => {
      item.addEventListener('click', () => {
        const voiceName = item.dataset.name;
        const voice = voices.find(v => v.name === voiceName);
        if (voice) {
          selectVoice(voice);
        }
      });
    });
  };
  
  // Populate traditional voice dropdown
  const populateVoiceDropdown = (voices) => {
    // Group options by language
    const langMap = new Map();
    voices.forEach(v => {
      v.languageCodes.forEach(code => {
        let name;
        try {
          name = new Intl.DisplayNames(['en'], { type: 'language' }).of(code);
        } catch (e) {
          name = code;
        }
        
        if (!langMap.has(code)) {
          langMap.set(code, { name, voices: [] });
        }
        langMap.get(code).voices.push(v);
      });
    });
    
    // Sort languages by name
    const sortedLangs = [...langMap.entries()]
      .sort((a, b) => a[1].name.localeCompare(b[1].name));
    
    // Group options by language
    const html = sortedLangs.map(([code, { name, voices }]) => {
      const options = voices
        .sort((a, b) => a.name.localeCompare(b.name))
        .map(v => `<option value="${v.name}" data-l="${code}">${v.name} (${v.ssmlGender})</option>`)
        .join('');
      
      return `<optgroup label="${name}">${options}</optgroup>`;
    }).join('');
    
    E.voice.innerHTML = html;
    E.voice.disabled = false;
    
    // Add change handler
    E.voice.addEventListener('change', () => {
      const selectedName = E.voice.value;
      const voice = voices.find(v => v.name === selectedName);
      if (voice) {
        selectVoice(voice);
      }
    });
  };
  
  // Select a voice
  const selectVoice = (voice) => {
    selectedVoice = voice;
    
    // Update UI
    document.querySelectorAll('.voice-item').forEach(item => {
      item.classList.toggle('selected', item.dataset.name === voice.name);
    });
    
    // Update dropdown also
    E.voice.value = voice.name;
    
    log(`Selected voice: ${voice.name}`);
    status(`Voice selected: ${voice.name
